---

- name: Docker setup
  block:
    - name: Install docker packages
      ansible.builtin.dnf:
        name: "{{ virtualization_docker.packages }}"
        state: present

    - name: Add user to docker group
      ansible.builtin.user:
        name: "{{ local_username }}"
        append: true
        groups: "{{ virtualization_docker.user_groups }}"

- name: Install and configure QEMU/KVM with libvirt
  block:
    - name: Install virtualization package groups
      ansible.builtin.dnf:
        name: "{{ virtualization_kvm_qemu.package_groups }}"
        state: present
        install_weak_deps: true

    - name: Install additional virtualization packages
      ansible.builtin.dnf:
        name: "{{ virtualization_kvm_qemu.packages }}"
        state: present

    - name: Enable and start required libvirt services
      ansible.builtin.systemd:
        name: "{{ item }}"
        enabled: true
        state: started
      loop: "{{ virtualization_kvm_qemu.systemd_services }}"

    - name: Add current user to libvirt groups
      ansible.builtin.user:
        name: "{{ local_username }}"
        groups: "{{ virtualization_kvm_qemu.user_groups | join(',') }}"
        append: true

    - name: Define and activate isolated network
      community.libvirt.virt_net:
        name: isolated
        state: present
        xml: |
          <network>
            <name>isolated</name>
            <bridge name="virbr69" stp="on" delay="0"/>
            <ip address="10.69.69.1" netmask="255.255.255.0">
              <dhcp>
                <range start="10.69.69.2" end="10.69.69.254"/>
              </dhcp>
            </ip>
          </network>

    - name: Ensure all networks are active
      community.libvirt.virt_net:
        name: "{{ item }}"
        state: active
      loop: "{{ virtualization_kvm_qemu.networks }}"

    - name: Ensure all networks are autostarted
      community.libvirt.virt_net:
        name: "{{ item }}"
        autostart: true
      loop: "{{ virtualization_kvm_qemu.networks }}"

    - name: Ensure custom libvirt storage directories exist with correct ownership
      ansible.builtin.file:
        path: "{{ item.path }}"
        state: directory
        owner: "{{ item.owner }}"
        group: "{{ item.group }}"
        mode: "{{ item.mode }}"
      loop:
        - { path: "/var/lib/libvirt/isos", owner: "root", group: "root", mode: "0755" }
        - { path: "/var/lib/libvirt/templates", owner: "qemu", group: "qemu", mode: "0750" }

    - name: Define persistent SELinux file context for custom directories
      community.general.sefcontext:
        target: "{{ item.target }}"
        setype: "{{ item.type }}"
        seuser: system_u
        state: present
      become: true
      loop:
        - { target: '/var/lib/libvirt/isos(/.*)?', type: virt_content_t }   # better for ISOs
        - { target: '/var/lib/libvirt/templates(/.*)?', type: virt_image_t }

    - name: Apply correct SELinux contexts recursively
      ansible.builtin.command: restorecon -Rv -F "{{ item }}"
      become: true
      changed_when: "'relabeled' in result.stdout"
      register: result
      loop:
        - /var/lib/libvirt/isos
        - /var/lib/libvirt/templates

    - name: Define ISO storage pool
      community.libvirt.virt_pool:
        name: isos
        state: present
        xml: |
          <pool type="dir">
            <name>isos</name>
            <target>
              <path>/var/lib/libvirt/isos</path>
            </target>
          </pool>

    - name: Define templates storage pool
      community.libvirt.virt_pool:
        name: templates
        state: present
        xml: |
          <pool type="dir">
            <name>templates</name>
            <target>
              <path>/var/lib/libvirt/templates</path>
            </target>
          </pool>

    - name: Activate iso and templates storage pool
      community.libvirt.virt_pool:
        name: "{{ item }}"
        state: active
      loop:
        - isos
        - templates

    - name: Autostart iso and templates storage pool
      community.libvirt.virt_pool:
        name: "{{ item }}"
        autostart: true
      loop:
        - isos
        - templates

- name: Configure Virt-Manager preferences
  become: true
  become_user: "{{ local_username }}"
  block:
    - name: Set Virt-Manager preferences
      community.general.dconf:
        key: "{{ item.0.base_path }}/{{ item.1.key }}"
        value: "{{ item.1.value }}"
      loop: "{{ virtualization_virt_manager_preferences.groups | subelements('items') }}"

...
